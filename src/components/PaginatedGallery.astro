---
import PhotoCard from './PhotoCard.astro';
import type { Photo } from '../types';

interface Props {
  photos: Photo[];
  category: string;
  initialCount?: number;
  loadMoreCount?: number;
}

const {
  photos,
  category,
  initialCount = 48,
  loadMoreCount = 48
} = Astro.props;

const initialPhotos = photos.slice(0, initialCount);
const hasMore = photos.length > initialCount;
---

<div class="paginated-gallery" data-category={category}>
  <div class="masonry-grid" id="photo-grid">
    {initialPhotos.map((photo) => (
      <PhotoCard photo={photo} category={category} />
    ))}
  </div>

  {hasMore && (
    <div class="load-more-container">
      <div id="infinite-scroll-sentinel" class="load-more-sentinel" aria-hidden="true"></div>
      <div id="infinite-scroll-loading" class="load-more-status" aria-live="polite">
        Loading more...
      </div>
    </div>
  )}

  <!-- Embed all photo data for client-side pagination -->
  <script define:vars={{ photos, category, initialCount, loadMoreCount }}>
    window.__galleryData = {
      photos: photos,
      category: category,
      initialCount: initialCount,
      loadMoreCount: loadMoreCount
    };
  </script>
</div>

<script>
  function initGallery() {
    const grid = document.getElementById('photo-grid');
    const sentinel = document.getElementById('infinite-scroll-sentinel');
    const loadingEl = document.getElementById('infinite-scroll-loading');

    if (!grid || !window.__galleryData || !sentinel) return;

    const { photos, category, loadMoreCount, initialCount } = window.__galleryData;
    let loaded = Math.min(initialCount, photos.length);
    const total = photos.length;
    let loading = false;
    let observer = null;

    function setLoading(state) {
      loading = state;
      if (loadingEl) {
        loadingEl.classList.toggle('visible', state);
      }
    }

    function loadNextBatch() {
      if (loading || loaded >= total) return;
      setLoading(true);

      const nextBatch = photos.slice(loaded, loaded + loadMoreCount);

      nextBatch.forEach(photo => {
        const card = createPhotoCard(photo, category);
        grid.appendChild(card);
      });

      loaded += nextBatch.length;
      setLoading(false);

      if (loaded >= total) {
        sentinel.remove();
        loadingEl?.remove();
        observer?.disconnect();
      }
    }

    if ('IntersectionObserver' in window) {
      observer = new IntersectionObserver((entries) => {
        if (entries.some(entry => entry.isIntersecting)) {
          loadNextBatch();
        }
      }, { rootMargin: '200px 0px' });

      observer.observe(sentinel);
    } else {
      const onScroll = () => {
        if (loading || loaded >= total) return;
        const scrollPos = window.innerHeight + window.scrollY;
        if (scrollPos >= document.body.offsetHeight - 600) {
          loadNextBatch();
        }
      };

      window.addEventListener('scroll', onScroll, { passive: true });
      onScroll();
    }
  }

  function createPhotoCard(photo, category) {
    const cloudinaryBase = 'https://res.cloudinary.com/dsilndqt6/image/upload';
    const thumbnailUrl = `${cloudinaryBase}/w_600,q_auto,f_auto/${photo.cloudinary_id}`;
    const fullUrl = `${cloudinaryBase}/w_1600,q_auto,f_auto/${photo.cloudinary_id}`;

    const card = document.createElement('div');
    card.className = 'photo-card';
    card.dataset.lightbox = 'true';
    card.dataset.fullUrl = fullUrl;
    card.dataset.title = photo.title;
    card.dataset.description = photo.description || '';
    card.dataset.species = photo.species || '';
    card.dataset.location = photo.location || '';
    card.dataset.href = `/${category}/${photo.slug}/`;
    card.dataset.filter = photo.filters?.length ? photo.filters.join(',') : 'none';

    card.innerHTML = `
      <a href="#" class="photo-link">
        <img
          src="${thumbnailUrl}"
          alt="${photo.title}"
          loading="lazy"
          width="${photo.width || ''}"
          height="${photo.height || ''}"
        />
      </a>
      <div class="photo-title-bar">
        <a href="/${category}/${photo.slug}/" class="photo-title">${photo.title}</a>
      </div>
    `;

    return card;
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initGallery);
  // Also handle Astro view transitions
  document.addEventListener('astro:page-load', initGallery);
</script>

<style>
  .masonry-grid {
    column-count: 1;
    column-gap: 1rem;
  }

  @media (min-width: 640px) {
    .masonry-grid {
      column-count: 2;
    }
  }

  @media (min-width: 1024px) {
    .masonry-grid {
      column-count: 3;
    }
  }

  @media (min-width: 1280px) {
    .masonry-grid {
      column-count: 4;
    }
  }

  .load-more-container {
    text-align: center;
    padding: 2rem 0;
  }

  .load-more-sentinel {
    height: 1px;
  }

  .load-more-status {
    display: none;
    color: #666;
    font-size: 0.9rem;
    margin-top: 0.75rem;
  }

  .load-more-status.visible {
    display: block;
  }

  /* Styles for dynamically loaded photo cards */
  :global(.photo-card) {
    position: relative;
    break-inside: avoid;
    margin-bottom: 1.25rem;
  }

  :global(.photo-link) {
    display: block;
    position: relative;
    overflow: hidden;
    border-radius: 4px;
  }

  :global(.photo-link img) {
    width: 100%;
    height: auto;
    display: block;
    transition: transform 0.3s ease;
  }

  :global(.photo-link:hover img) {
    transform: scale(1.03);
  }

  :global(.photo-title-bar) {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    padding: 0.75rem 0.85rem;
    background: linear-gradient(
      to top,
      rgba(0, 0, 0, 0.75) 0%,
      rgba(0, 0, 0, 0) 100%
    );
    opacity: 0;
    transform: translateY(6px);
    transition: opacity 0.2s ease, transform 0.2s ease;
    pointer-events: none;
    border-radius: 0 0 4px 4px;
  }

  :global(.photo-card:hover .photo-title-bar),
  :global(.photo-card:focus-within .photo-title-bar) {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  :global(.photo-title) {
    color: white;
    font-size: 0.85rem;
    font-weight: 500;
    line-height: 1.3;
    text-decoration: none;
    display: block;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  :global(.photo-title:hover) {
    color: #93c5fd;
  }
</style>
